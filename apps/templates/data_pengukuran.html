{% extends 'base.html' %} {% block title %}Data Pengukuran{% endblock %} {% block content %}
<div id="deleteConfirmModal" class="modal-overlay" style="display: none">
	<div class="modal-content">
		<h2>Konfirmasi Penghapusan</h2>
		<p>
			Apakah Anda yakin ingin menghapus data pasien <strong id="deletePatientName" style="color: #dc3545"></strong>?
			Semua riwayat pengukurannya juga akan terhapus secara permanen.
		</p>
		<div class="modal-actions">
			<button id="btnCancelDelete" class="btn-modal btn-secondary">Batal</button>
			<button id="btnConfirmDelete" class="btn-modal btn-danger">Ya, Hapus</button>
		</div>
	</div>
</div>
<div id="editPatientModal" class="modal-overlay" style="display: none">
	<div class="modal-content" style="text-align: left">
		<h2>Edit Data Pasien</h2>
		<form id="editPatientForm">
			<input type="hidden" id="edit_patient_id" name="patient_id" />
			<div class="form-row">
				<div class="form-group">
					<label for="edit_nama_lengkap">Nama Pasien</label>
					<input type="text" id="edit_nama_lengkap" name="nama_lengkap" required />
				</div>
				<div class="form-group">
					<label for="edit_jenis_kelamin">Jenis Kelamin</label>
					<select id="edit_jenis_kelamin" name="jenis_kelamin">
						<option value="Laki-laki">Laki-laki</option>
						<option value="Perempuan">Perempuan</option>
					</select>
				</div>
			</div>
			<div class="form-row">
				<div class="form-group">
					<label for="edit_umur">Umur</label>
					<input type="number" id="edit_umur" name="umur" required />
				</div>
				<div class="form-group">
					<label for="edit_nik">NIK</label>
					<input type="text" id="edit_nik" name="nik" required />
				</div>
			</div>
			<div class="form-group">
				<label for="edit_alamat">Alamat</label>
				<input type="text" id="edit_alamat" name="alamat" required />
			</div>
			<div class="form-group">
				<label for="edit_no_hp">No. HP</label>
				<input type="text" id="edit_no_hp" name="no_hp" required />
			</div>
			<div class="modal-actions" style="justify-content: flex-end">
				<button type="button" class="btn-modal btn-secondary" id="cancelEditBtn">Batal</button>
				<button type="submit" class="btn-modal btn-primary">Simpan Perubahan</button>
			</div>
		</form>
	</div>
</div>
<div id="patientListView">
	<div class="page-header">
		<h1 class="page-title">Data Pengukuran Pasien</h1>
		<div class="header-actions">
			<button id="btnUploadData" class="btn-export-all" style="background-color: #28a745">Upload Data</button>
			<a href="#" id="exportSelectedBtn" class="btn-export-all disabled">Export Selected</a>
			<a href="{{ url_for('export_all') }}" class="btn-export-all">Export All</a>
		</div>
	</div>

	<div class="patient-list">
		{% for patient in patients %}
		<div class="patient-row" data-patient-id="{{ patient[0] }}" data-patient-name="{{ patient[1] }}">
			<div class="patient-info">
				<input type="checkbox" class="patient-checkbox" value="{{ patient[0] }}" />
				<span class="patient-name">{{ patient[1] }}</span>
			</div>
			<div class="patient-meta">
				<span class="last-measured">Pengukuran Terakhir: {{ patient[2].strftime('%d %b %Y, %H:%M') }}</span>
				<div class="actions">
					<a href="#" class="action-btn action-btn-edit">Edit</a>
					<a href="#" class="action-btn action-btn-delete">Delete</a>
					<a href="{{ url_for('export_patient', patient_id=patient[0]) }}" class="action-btn">Export</a>
				</div>
			</div>
		</div>
		{% else %}
		<p>Belum ada data pengukuran yang tersimpan.</p>
		{% endfor %}
	</div>
</div>

<div id="patientDetailView" style="display: none;">
    <div class="page-header">
        <button id="backToListBtn" class="btn-back"><i class="fas fa-arrow-left"></i> Kembali</button>
        <h1 class="page-title">Detail Riwayat</h1>
        <button id="btnUploadCurrentPatient" class="btn-action btn-print" style="background-color: #28a745;">
            <i class="fas fa-cloud-upload-alt"></i> Upload Data Ini
        </button>
    </div>

    <div id="biodataContainer" class="form-container" style="margin-bottom: 25px;">
        <h3>Biodata Pasien</h3>
        <div class="form-row">
            <div class="form-group"><p><strong>Nama:</strong> <span id="bio_nama"></span></p></div>
            <div class="form-group"><p><strong>NIK:</strong> <span id="bio_nik"></span></p></div>
            <div class="form-group"><p><strong>Umur:</strong> <span id="bio_umur"></span></p></div>
            <div class="form-group"><p><strong>Gender:</strong> <span id="bio_jenis_kelamin"></span></p></div>
            <div class="form-group"><p><strong>Alamat:</strong> <span id="bio_alamat"></span></p></div>
        </div>
    </div>

    <div class="filter-toolbar form-container" style="margin-bottom: 20px; padding: 15px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
        <span style="font-weight: 600;">Filter Waktu:</span>
        <button class="btn-filter" data-range="today">Hari Ini</button>
        <button class="btn-filter" data-range="week">1 Minggu</button>
        <button class="btn-filter" data-range="month">1 Bulan</button>
        <div style="border-left: 1px solid #ccc; height: 30px; margin: 0 10px;"></div>
        <input type="date" id="startDateFilter" class="date-input">
        <span>s/d</span>
        <input type="date" id="endDateFilter" class="date-input">
        <button id="btnApplyFilter" class="btn-filter btn-primary">Terapkan</button>
        <button id="btnResetFilter" class="btn-filter btn-secondary">Reset (Semua)</button>
    </div>
    
    <div class="chart-container">
        <canvas id="measurementChart"></canvas>
    </div>
</div>

{% endblock %} {% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
	$(document).ready(function () {
		const listView = $("#patientListView");
		const detailView = $("#patientDetailView");
		const detailPatientName = $("#detailPatientName");
		let measurementChart = null; // Variabel untuk menyimpan objek chart
		let currentPatientId = null;

		// --- FUNGSI LOAD CHART DENGAN FILTER ---
    function loadPatientData(patientId, startDate = null, endDate = null) {
        currentPatientId = patientId;
        
        let url = `/api/patient_measurements/${patientId}`;
        // Tambahkan query params jika ada filter tanggal
        if (startDate && endDate) {
            url += `?start_date=${startDate}&end_date=${endDate}`;
        }

        $.getJSON(url, function(data) {
            // Isi Biodata (sama seperti sebelumnya)
            const bio = data.biodata;
            $('#bio_nama').text(bio.nama);
            $('#bio_nik').text(bio.nik);
            $('#bio_umur').text(bio.umur);
            $('#bio_jenis_kelamin').text(bio.jenis_kelamin);
            $('#bio_alamat').text(bio.alamat);

            // Render Chart
            if (measurementChart) measurementChart.destroy();
            const ctx = document.getElementById('measurementChart').getContext('2d');
            measurementChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.chart_data.labels,
                    datasets: [
                        { label: 'Kolesterol', data: data.chart_data.cholesterol, borderColor: '#3498db', backgroundColor: 'rgba(52, 152, 219, 0.2)', tension: 0.1 },
                        { label: 'Asam Urat', data: data.chart_data.uric_acid, borderColor: '#e67e22', backgroundColor: 'rgba(230, 126, 34, 0.2)', tension: 0.1 },
                        { label: 'Gula Darah', data: data.chart_data.blood_sugar, borderColor: '#2ecc71', backgroundColor: 'rgba(46, 204, 113, 0.2)', tension: 0.1 }
                    ]
                },
                options: { responsive: true, plugins: { title: { display: true, text: 'Grafik Riwayat Kesehatan' } } }
            });
        });
    }
		// Saat baris pasien diklik
		$('.patient-row').on('click', function(e) {
        if ($(e.target).is('input, a')) return;
        const pid = $(this).data('patient-id');
        listView.hide();
        detailView.show();
        // Reset input tanggal saat buka pasien baru
        $('#startDateFilter').val('');
        $('#endDateFilter').val('');
        loadPatientData(pid); // Load semua data awal
    });

    // --- LOGIKA TOMBOL FILTER ---
    $('.btn-filter[data-range]').on('click', function() {
        const range = $(this).data('range');
        const end = new Date();
        let start = new Date();

        // Set waktu ke akhir hari ini agar mencakup data hari ini
        end.setHours(23, 59, 59, 999); 

        if (range === 'today') {
            start.setHours(0, 0, 0, 0);
        } else if (range === 'week') {
            start.setDate(end.getDate() - 7);
        } else if (range === 'month') {
            start.setMonth(end.getMonth() - 1);
        }

        // Format ke YYYY-MM-DD HH:MM:SS untuk backend
        const fmt = (d) => d.toISOString().slice(0, 19).replace('T', ' ');
        
        // Update tampilan input date
        $('#startDateFilter').val(start.toISOString().slice(0, 10));
        $('#endDateFilter').val(end.toISOString().slice(0, 10));

        loadPatientData(currentPatientId, fmt(start), fmt(end));
    });

    $('#btnApplyFilter').on('click', function() {
        let s = $('#startDateFilter').val();
        let e = $('#endDateFilter').val();
        if(s && e) {
            // Tambahkan jam agar filter akurat (awal hari s/d akhir hari)
            loadPatientData(currentPatientId, s + " 00:00:00", e + " 23:59:59");
        } else {
            alert("Pilih tanggal mulai dan selesai.");
        }
    });

    $('#btnResetFilter').on('click', function() {
        $('#startDateFilter').val('');
        $('#endDateFilter').val('');
        loadPatientData(currentPatientId); // Load tanpa filter (semua)
    });

    // --- LOGIKA UPLOAD DATA PASIEN INI ---
    $('#btnUploadCurrentPatient').on('click', function() {
        const btn = $(this);
        const originalText = btn.html();
        
        // Ambil filter tanggal saat ini (jika ada)
        let s = $('#startDateFilter').val();
        let e = $('#endDateFilter').val();
        let payload = {};
        
        if (s && e) {
            payload = { start_date: s + " 00:00:00", end_date: e + " 23:59:59" };
        }

        if(confirm("Upload data yang sedang ditampilkan ke server?")) {
            btn.prop('disabled', true).text('Mengirim...');
            
            $.ajax({
                url: `/upload_patient_data/${currentPatientId}`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function(res) {
                    alert(res.message);
                },
                error: function(err) {
                    alert("Gagal upload: " + (err.responseJSON ? err.responseJSON.message : err.statusText));
                },
                complete: function() {
                    btn.prop('disabled', false).html(originalText);
                }
            });
        }
    });

    $('#backToListBtn').on('click', function() { detailView.hide(); listView.show(); });

	
		const editModal = $("#editPatientModal");

		// 1. Saat tombol "Edit" di salah satu baris diklik
		$(".action-btn-edit").on("click", function (e) {
			e.preventDefault(); // Mencegah link default
			e.stopPropagation(); // Mencegah event klik di baris (.patient-row)

			const row = $(this).closest(".patient-row");
			const patientId = row.data("patient-id");

			// Ambil data terbaru pasien dari API
			$.getJSON(`/api/patient/${patientId}`, function (data) {
				// Isi form di dalam modal dengan data yang didapat
				$("#edit_patient_id").val(data.id);
				$("#edit_nama_lengkap").val(data.nama_lengkap);
				$("#edit_jenis_kelamin").val(data.jenis_kelamin);
				$("#edit_alamat").val(data.alamat);
				$("#edit_umur").val(data.umur);
				$("#edit_nik").val(data.nik);
				$("#edit_no_hp").val(data.no_hp);

				// Simpan patientId ke form untuk submit
				$("#editPatientForm").data("patient-id", data.id);

				// Tampilkan modal
				editModal.css("display", "flex");
			});
		});

		// 2. Saat form edit di-submit
		$("#editPatientForm").on("submit", function (e) {
			e.preventDefault();
			const patientId = $(this).data("patient-id");
			const formData = $(this).serialize();

			$.ajax({
				url: `/patient/edit/${patientId}`,
				method: "POST",
				data: formData,
				success: function (response) {
					if (response.status === "success") {
						// Tutup modal
						editModal.hide();
						// Tampilkan notifikasi sukses
						showNotification(response.message, "success"); // Asumsi Anda punya fungsi ini

						// Update nama di daftar pasien secara real-time
						const updatedName = $("#edit_nama_lengkap").val();
						$(`.patient-row[data-patient-id=${patientId}] .patient-name`).text(updatedName);
					}
				},
				error: function () {
					showNotification("Gagal memperbarui data.", "danger");
				},
			});
		});

		// 3. Saat tombol "Batal" di modal diklik
		$("#cancelEditBtn").on("click", function () {
			editModal.hide();
		});

		// Tambahkan juga fungsi notifikasi jika belum ada
		function showNotification(message, category) {
			const flashMessage = $("<div></div>").addClass(`flash-message flash-${category}`).text(message);
			$(".flash-messages-container").append(flashMessage);
			setTimeout(() => {
				flashMessage.fadeOut(500, function () {
					$(this).remove();
				});
			}, 5000);
		}
		// --- LOGIKA UNTUK FITUR DELETE ---
		$(".action-btn-delete").on("click", function (e) {
			e.preventDefault();
			e.stopPropagation();

			// 1. Ambil data dari baris yang diklik
			const row = $(this).closest(".patient-row");
			const patientId = row.data("patient-id");
			const patientName = row.data("patient-name");

			// 2. Masukkan nama pasien ke dalam modal dan tampilkan
			$("#deletePatientName").text(patientName);
			$("#deleteConfirmModal").css("display", "flex");

			// 3. Simpan ID pasien di tombol konfirmasi untuk digunakan nanti
			$("#btnConfirmDelete").data("patient-id", patientId);
			$("#btnConfirmDelete").data("row-element", row); // Simpan juga elemen barisnya
		});

		// Event handler untuk tombol "Ya, Hapus" di dalam modal
		$("#btnConfirmDelete").on("click", function () {
			const patientId = $(this).data("patient-id");
			const row = $(this).data("row-element");

			$.ajax({
				url: `/patient/delete/${patientId}`,
				method: "POST",
				success: function (response) {
					if (response.status === "success") {
						showNotification(response.message, "success");
						// Hilangkan baris dari tabel
						row.fadeOut(500, function () {
							$(this).remove();
						});
					}
				},
				error: function () {
					showNotification("Gagal menghapus data.", "danger");
				},
				complete: function () {
					// Selalu sembunyikan modal setelah selesai
					$("#deleteConfirmModal").hide();
				},
			});
		});

		// Event handler untuk tombol "Batal"
		$("#btnCancelDelete").on("click", function () {
			$("#deleteConfirmModal").hide();
		});

		// --- LOGIKA UNTUK FITUR EXPORT SELECTED ---
		const exportSelectedBtn = $("#exportSelectedBtn");

		// Cek setiap kali checkbox diubah
		$(".patient-checkbox").on("change", function () {
			// Kumpulkan semua checkbox yang dicentang
			const selectedCheckboxes = $(".patient-checkbox:checked");

			if (selectedCheckboxes.length > 0) {
				const selectedIds = selectedCheckboxes
					.map(function () {
						return $(this).val();
					})
					.get();

				const exportUrl = `{{ url_for('export_selected') }}?ids=${selectedIds.join(",")}`;

				// Aktifkan tombol: hapus class disabled dan atur URL
				exportSelectedBtn.attr("href", exportUrl).removeClass("disabled");
			} else {
				// Nonaktifkan tombol: hapus URL dan tambahkan class disabled
				exportSelectedBtn.removeAttr("href").addClass("disabled");
			}
		});

		// Saat tombol "Kembali" diklik
		$("#backToListBtn").on("click", function () {
			detailView.hide();
			listView.show();
		});
		$("#btnUploadData").on("click", function () {
			if (!confirm("Apakah Anda yakin ingin mengunggah semua data pengukuran ke server?")) {
				return;
			}

			const button = $(this);
			const originalText = button.text();
			button.prop("disabled", true).text("Mengunggah...");

			$.ajax({
				url: "{{ url_for('upload_data') }}",
				method: "POST",
				success: function (response) {
					showNotification(response.message, "success");
				},
				error: function (xhr) {
					// xhr.responseJSON.message akan berisi pesan error dari server Flask kita
					const message = xhr.responseJSON ? xhr.responseJSON.message : "Terjadi error tidak diketahui.";
					showNotification(message, "danger");
				},
				complete: function () {
					// Kembalikan tombol ke keadaan semula setelah selesai
					button.prop("disabled", false).text(originalText);
				},
			});
		});
	});
</script>
{% endblock %}
