{% extends 'base.html' %} 
{% block title %}Data Pengukuran{% endblock %} 

{% block content %}
<div id="deleteConfirmModal" class="modal-overlay" style="display: none">
    <div class="modal-content">
        <h2>Konfirmasi Penghapusan</h2>
        <p>
            Apakah Anda yakin ingin menghapus data pasien <strong id="deletePatientName" style="color: #dc3545"></strong>?
            Semua riwayat pengukurannya juga akan terhapus secara permanen.
        </p>
        <div class="modal-actions">
            <button id="btnCancelDelete" class="btn-modal btn-secondary">Batal</button>
            <button id="btnConfirmDelete" class="btn-modal btn-danger">Ya, Hapus</button>
        </div>
    </div>
</div>

<div id="editPatientModal" class="modal-overlay" style="display: none">
    <div class="modal-content" style="text-align: left">
        <h2>Edit Data Pasien</h2>
        <form id="editPatientForm">
            <input type="hidden" id="edit_patient_id" name="patient_id" />
            <div class="form-row">
                <div class="form-group">
                    <label for="edit_nama_lengkap">Nama Pasien</label>
                    <input type="text" id="edit_nama_lengkap" name="nama_lengkap" required />
                </div>
                <div class="form-group">
                    <label for="edit_jenis_kelamin">Jenis Kelamin</label>
                    <select id="edit_jenis_kelamin" name="jenis_kelamin">
                        <option value="Laki-laki">Laki-laki</option>
                        <option value="Perempuan">Perempuan</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="edit_umur">Umur</label>
                    <input type="number" id="edit_umur" name="umur" required />
                </div>
                <div class="form-group">
                    <label for="edit_nik">NIK</label>
                    <input type="text" id="edit_nik" name="nik" required />
                </div>
            </div>
            <div class="form-group">
                <label for="edit_alamat">Alamat</label>
                <input type="text" id="edit_alamat" name="alamat" required />
            </div>
            <div class="form-group">
                <label for="edit_no_hp">No. HP</label>
                <input type="text" id="edit_no_hp" name="no_hp" required />
            </div>
            <div class="modal-actions" style="justify-content: flex-end">
                <button type="button" class="btn-modal btn-secondary" id="cancelEditBtn">Batal</button>
                <button type="submit" class="btn-modal btn-primary">Simpan Perubahan</button>
            </div>
        </form>
    </div>
</div>

<div id="patientListView">
    <div class="page-header">
        <h1 class="page-title">Data Pengukuran Pasien</h1>
        <div class="header-actions">
            <button id="btnUploadData" class="btn-export-all" style="background-color: #28a745">
                <i class="fas fa-cloud-upload-alt"></i> Upload Data
            </button>
            <a href="#" id="exportSelectedBtn" class="btn-export-all disabled">Export Selected</a>
            <a href="{{ url_for('export_all') }}" class="btn-export-all">Export All</a>
        </div>
    </div>

    <div class="form-container" style="padding: 15px; margin-bottom: 20px; display: flex; align-items: center; gap: 15px; flex-wrap: wrap; background-color: #f8f9fa; border: 1px solid #e9ecef;">
        
        <div style="display: flex; align-items: center; gap: 8px; flex: 1; min-width: 250px;">
            <i class="fas fa-search" style="color: #555;"></i>
            <input type="text" id="globalSearchInput" class="form-control" placeholder="Cari Nama Pasien / NIK..." value="{{ search_query }}" style="padding: 5px 10px;">
        </div>

        <div style="border-left: 1px solid #ccc; height: 30px; display: none; margin: 0 5px;" class="d-md-block"></div>

        <div style="display: flex; align-items: center; gap: 8px;">
            <span style="font-weight: 600; color: #555; white-space: nowrap;">Filter Waktu:</span>
            <input type="date" id="globalStartDate" class="date-input" value="{{ start_date if start_date else '' }}">
            <span>s/d</span>
            <input type="date" id="globalEndDate" class="date-input" value="{{ end_date if end_date else '' }}">
        </div>
        
        <div style="display: flex; gap: 5px;">
            <button id="btnGlobalFilter" class="btn-filter btn-primary"><i class="fas fa-filter"></i> Terapkan</button>
            <button id="btnGlobalReset" class="btn-filter btn-secondary"><i class="fas fa-sync-alt"></i> Reset</button>
        </div>
    </div>

    <div class="patient-list">
        {% if patients %}
            {% for patient in patients %}
            <div class="patient-row" data-patient-id="{{ patient[0] }}" data-patient-name="{{ patient[1] }}">
                <div class="patient-info">
                    <input type="checkbox" class="patient-checkbox" value="{{ patient[0] }}" />
                    <span class="patient-name">{{ patient[1] }}</span>
                </div>
                <div class="patient-meta">
                    <span class="last-measured">Pengukuran Terakhir: {{ patient[2].strftime('%d %b %Y, %H:%M') }}</span>
                    <div class="actions">
                        <a href="#" class="action-btn action-btn-edit">Edit</a>
                        <a href="#" class="action-btn action-btn-delete">Delete</a>
                        <a href="{{ url_for('export_patient', patient_id=patient[0]) }}" class="action-btn">Export</a>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div style="text-align: center; padding: 20px; color: #666;">
                <p>Tidak ada data pengukuran ditemukan pada rentang waktu ini.</p>
            </div>
        {% endif %}
    </div>
</div>

<div id="patientDetailView" style="display: none;">
    <div class="page-header">
        <button id="backToListBtn" class="btn-back"><i class="fas fa-arrow-left"></i> Kembali</button>
        <h1 class="page-title">Detail Riwayat</h1>
        <button id="btnUploadCurrentPatient" class="btn-action btn-print" style="background-color: #28a745;">
            <i class="fas fa-cloud-upload-alt"></i> Upload Data Ini
        </button>
    </div>

    <div id="biodataContainer" class="form-container" style="margin-bottom: 25px;">
        <h3>Biodata Pasien</h3>
        
        <div class="form-row" style="display: flex; gap: 20px; margin-bottom: 15px;">
            <div class="form-group" style="flex: 1;">
                <p style="margin: 0; color: #666; font-size: 0.9rem;">Nama Lengkap</p>
                <p style="margin: 0; font-weight: bold; font-size: 1.1rem;"><span id="bio_nama">-</span></p>
            </div>
            <div class="form-group" style="flex: 1;">
                <p style="margin: 0; color: #666; font-size: 0.9rem;">NIK</p>
                <p style="margin: 0; font-weight: bold; font-size: 1.1rem;"><span id="bio_nik">-</span></p>
            </div>
            <div class="form-group" style="flex: 1;">
                <p style="margin: 0; color: #666; font-size: 0.9rem;">Jenis Kelamin</p>
                <p style="margin: 0; font-weight: bold; font-size: 1.1rem;"><span id="bio_jenis_kelamin">-</span></p>
            </div>
        </div>

        <div class="form-row" style="display: flex; gap: 20px; margin-bottom: 15px;">
            <div class="form-group" style="flex: 1;">
                <p style="margin: 0; color: #666; font-size: 0.9rem;">Umur</p>
                <p style="margin: 0; font-weight: bold;"><span id="bio_umur">-</span></p>
            </div>
            <div class="form-group" style="flex: 1;">
                <p style="margin: 0; color: #666; font-size: 0.9rem;">Kecamatan</p>
                <p style="margin: 0; font-weight: bold;"><span id="bio_kecamatan">-</span></p>
            </div>
            <div class="form-group" style="flex: 1;">
                <p style="margin: 0; color: #666; font-size: 0.9rem;">Kelurahan</p>
                <p style="margin: 0; font-weight: bold;"><span id="bio_kelurahan">-</span></p>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group" style="flex: 1; border-top: 1px solid #eee; padding-top: 10px;">
                <p style="margin: 0; color: #666; font-size: 0.9rem;">Alamat Lengkap</p>
                <p style="margin: 0; font-weight: bold;"><span id="bio_alamat">-</span></p>
            </div>
        </div>
    </div>

    <div class="filter-toolbar form-container" style="margin-bottom: 20px; padding: 15px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
        <span style="font-weight: 600;">Filter Waktu:</span>
        <button class="btn-filter" data-range="today">Hari Ini</button>
        <button class="btn-filter" data-range="week">1 Minggu</button>
        <button class="btn-filter" data-range="month">1 Bulan</button>
        <div style="border-left: 1px solid #ccc; height: 30px; margin: 0 10px;"></div>
        <input type="date" id="startDateFilter" class="date-input">
        <span>s/d</span>
        <input type="date" id="endDateFilter" class="date-input">
        <button id="btnApplyFilter" class="btn-filter btn-primary">Terapkan</button>
        <button id="btnResetFilter" class="btn-filter btn-secondary">Reset (Semua)</button>
    </div>
    
    <div class="card mb-4 shadow-sm" style="border-radius: 12px; overflow: hidden;">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h3 class="mb-0 font-weight-bold">Riwayat Pengukuran Lengkap</h3>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive" style="max-height: 350px; overflow-y: auto;">
                <table class="table table-striped table-hover mb-0" id="historyTable" style="width: 100%; border-collapse: separate; border-spacing: 0;">
                    <thead class="thead-light" style="position: sticky; top: 0; z-index: 1020;">
                        <tr>
                            <th class="text-center align-middle py-3" style="background-color: #e9ecef; width: 50px;">No</th>
                            <th class="text-center align-middle py-3" style="background-color: #e9ecef;">Tanggal & Waktu</th>
                            <th class="text-center align-middle py-3" style="background-color: #e9ecef;">Kolesterol<br><span class="text-muted" style="font-size: 0.85em; font-weight: normal;">(mg/dL)</span></th>
                            <th class="text-center align-middle py-3" style="background-color: #e9ecef;">Asam Urat<br><span class="text-muted" style="font-size: 0.85em; font-weight: normal;">(mg/dL)</span></th>
                            <th class="text-center align-middle py-3" style="background-color: #e9ecef;">Gula Darah<br><span class="text-muted" style="font-size: 0.85em; font-weight: normal;">(mg/dL)</span></th>
                            <th class="text-center align-middle py-3" style="background-color: #e9ecef;">Tensi<br><span class="text-muted" style="font-size: 0.85em; font-weight: normal;">(mmHg)</span></th>
                            <th class="text-center align-middle py-3" style="background-color: #e9ecef;">Tinggi<br><span class="text-muted" style="font-size: 0.85em; font-weight: normal;">(cm)</span></th>
                            <th class="text-center align-middle py-3" style="background-color: #e9ecef;">Berat<br><span class="text-muted" style="font-size: 0.85em; font-weight: normal;">(kg)</span></th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="row"></div>
    
    <div class="chart-container">
        <canvas id="measurementChart"></canvas>
    </div>
</div>

{% endblock %} 

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    $(document).ready(function () {
        const listView = $("#patientListView");
        const detailView = $("#patientDetailView");
        const detailPatientName = $("#detailPatientName");
        let measurementChart = null; 
        let currentPatientId = null;

        // --- 1. LOGIKA FILTER GLOBAL (List Pasien) ---
        // Tombol Terapkan Filter
        // --- 1. LOGIKA FILTER GLOBAL (Search & Date) ---
    
    // Fungsi Utama Filter
    function applyGlobalFilter() {
        let q = $('#globalSearchInput').val();
        let s = $('#globalStartDate').val();
        let e = $('#globalEndDate').val();
        
        // Bangun URL Query String
        let url = `{{ url_for('data_pengukuran') }}?`;
        let params = [];
        
        if (q) params.push(`q=${encodeURIComponent(q)}`);
        if (s) params.push(`start_date=${s}`);
        if (e) params.push(`end_date=${e}`);
        
        // Redirect
        if (params.length > 0) {
            window.location.href = url + params.join('&');
        } else {
            // Jika kosong semua, reload ke halaman bersih
            window.location.href = `{{ url_for('data_pengukuran') }}`;
        }
    }

    // Tombol Terapkan (Bisa untuk tanggal & search sekaligus)
    $('#btnGlobalFilter').click(function() {
        applyGlobalFilter();
    });

    // Tekan Enter di kolom pencarian -> langsung cari
    $('#globalSearchInput').keypress(function(e) {
        if(e.which == 13) applyGlobalFilter();
    });

    // Tombol Reset
    $('#btnGlobalReset').click(function() {
        window.location.href = `{{ url_for('data_pengukuran') }}`;
    });

        // --- 2. UPLOAD DATA DENGAN FILTER ---
        // Menggunakan filter tanggal global untuk menentukan data yang diupload
        // --- 2. UPLOAD DATA CERDAS (Checkbox > Search > Global) ---
        $("#btnUploadData").on("click", function () {
            // 1. Ambil Parameter Tanggal
            let s = $('#globalStartDate').val();
            let e = $('#globalEndDate').val();
            let datePayload = {};
            let dateMsg = "";
            
            if (s && e) {
                datePayload = { start_date: s + " 00:00:00", end_date: e + " 23:59:59" };
                dateMsg = ` pada rentang ${s} s/d ${e}`;
            }

            // 2. Cek Checkbox (Prioritas Tertinggi)
            let selectedIds = [];
            $(".patient-checkbox:checked").each(function() {
                selectedIds.push($(this).val());
            });

            // 3. Cek Search Query (Jika tidak ada checkbox)
            let searchQuery = $('#globalSearchInput').val();

            // --- MENENTUKAN LOGIKA UPLOAD ---
            let payload = { ...datePayload }; // Copy object tanggal
            let msg = "";

            if (selectedIds.length > 0) {
                // KASUS A: Upload Pasien Terpilih
                payload.patient_ids = selectedIds;
                msg = `Mengunggah data milik ${selectedIds.length} pasien terpilih${dateMsg}?`;
            } 
            else if (searchQuery) {
                // KASUS B: Upload Hasil Pencarian
                payload.search_query = searchQuery;
                msg = `Mengunggah data hasil pencarian "${searchQuery}"${dateMsg}?`;
            } 
            else {
                // KASUS C: Upload Global / Semua
                if (s && e) {
                    msg = `Mengunggah SEMUA data${dateMsg}?`;
                } else {
                    msg = "PERINGATAN: Anda akan mengunggah SELURUH data di database (tanpa filter). Lanjutkan?";
                }
            }

            // Eksekusi
            if (!confirm(msg)) return;

            const button = $(this);
            const originalText = button.html(); // Simpan icon/text asli
            button.prop("disabled", true).html('<i class="fas fa-spinner fa-spin"></i> Mengirim...');
            
            $.ajax({
                url: "{{ url_for('upload_data') }}",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify(payload),
                success: function (response) { 
                    showNotification(response.message, "success"); 
                    // Opsional: Uncheck semua checkbox setelah sukses
                    $(".patient-checkbox").prop('checked', false);
                },
                error: function (xhr) {
                    const message = xhr.responseJSON ? xhr.responseJSON.message : "Terjadi error tidak diketahui.";
                    showNotification(message, "danger");
                },
                complete: function () { 
                    button.prop("disabled", false).html(originalText); 
                }
            });
        });

        // --- FUNGSI LOAD DATA (CHART + TABEL) ---
        function loadPatientData(patientId, startDate = null, endDate = null) {
            currentPatientId = patientId;
            
            let url = `/api/patient_measurements/${patientId}`;
            if (startDate && endDate) {
                url += `?start_date=${startDate}&end_date=${endDate}`;
            }

            // Tampilkan loading di tabel sebelum data datang
            $('#historyTableBody').html('<tr><td colspan="8" class="text-center"><i class="fas fa-spinner fa-spin"></i> Memuat data...</td></tr>');

            $.getJSON(url, function(data) {
                // 1. Isi Biodata
                const bio = data.biodata;
                $('#bio_nama').text(bio.nama);
                $('#bio_nik').text(bio.nik);
                $('#bio_umur').text(bio.umur);
                $('#bio_jenis_kelamin').text(bio.jenis_kelamin);
                $('#bio_alamat').text(bio.alamat);
                $('#bio_kecamatan').text(bio.kecamatan || '-');
                $('#bio_kelurahan').text(bio.kelurahan || '-');

                // 2. Render Tabel History (Fungsi Baru)
                if (data.history) {
                    renderHistoryTable(data.history);
                } else {
                    $('#historyTableBody').html('<tr><td colspan="8" class="text-center text-danger">Data history tidak ditemukan dari server.</td></tr>');
                }

                // 3. Render Chart (Logika Lama)
                if (measurementChart) measurementChart.destroy();
                const ctx = document.getElementById('measurementChart').getContext('2d');
                measurementChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.chart_data.labels,
                        datasets: [
                            { label: 'Kolesterol', data: data.chart_data.cholesterol, borderColor: '#3498db', backgroundColor: 'rgba(52, 152, 219, 0.2)', tension: 0.1 },
                            { label: 'Asam Urat', data: data.chart_data.uric_acid, borderColor: '#e67e22', backgroundColor: 'rgba(230, 126, 34, 0.2)', tension: 0.1 },
                            { label: 'Gula Darah', data: data.chart_data.blood_sugar, borderColor: '#2ecc71', backgroundColor: 'rgba(46, 204, 113, 0.2)', tension: 0.1 }
                        ]
                    },
                    options: { responsive: true, plugins: { title: { display: true, text: 'Grafik Riwayat Kesehatan' } } }
                });
            }).fail(function() {
                alert("Gagal mengambil data pasien.");
                $('#historyTableBody').html('<tr><td colspan="8" class="text-center text-danger">Gagal memuat data.</td></tr>');
            });
        }

        // --- FUNGSI RENDER TABEL ---
        function renderHistoryTable(data) {
            const tbody = $('#historyTableBody');
            tbody.empty();

            if (data.length === 0) {
                tbody.html(`
                    <tr>
                        <td colspan="8" class="text-center py-4 text-muted">
                            <i class="fas fa-info-circle fa-2x mb-2"></i><br>
                            Tidak ada data riwayat pada periode ini.
                        </td>
                    </tr>
                `);
                return;
            }

            data.forEach((item, index) => {
                // Helper: Format nilai kosong
                const val = (v) => (v && v > 0) ? `<strong>${v}</strong>` : `<span class="text-muted" style="opacity: 0.5;">-</span>`;
                
                // Format Tensi
                let tensi = `<span class="text-muted" style="opacity: 0.5;">-</span>`;
                if (item.blood_pressure_sys > 0 || item.blood_pressure_dia > 0) {
                    let style = "font-weight: 500;";
                    if (item.blood_pressure_sys >= 140 || item.blood_pressure_dia >= 90) style += "color: #e74c3c;";
                    tensi = `<strong><span style="${style}">${item.blood_pressure_sys}/${item.blood_pressure_dia}</span></strong>`;
                }

                let dateDisplay = item.formatted_date;
                if (dateDisplay && dateDisplay.includes(" ")) {
                    const parts = dateDisplay.split(" ");
                    dateDisplay = `
                        <div style="line-height: 1.2;">
                            <span style="font-weight: 500;">${parts[0]}</span><br>
                        </div>
                    `;
                }

                const row = `
                    <tr>
                        <td class="align-middle"><div class="d-flex justify-content-center">${index + 1}</div></td>
                        <td class="align-middle"><div class="d-flex justify-content-center text-center">${dateDisplay}</div></td>
                        <td class="align-middle"><div class="d-flex justify-content-center">${val(item.cholesterol_value)}</div></td>
                        <td class="align-middle"><div class="d-flex justify-content-center">${val(item.uric_acid_value)}</div></td>
                        <td class="align-middle"><div class="d-flex justify-content-center">${val(item.blood_sugar_value)}</div></td>
                        <td class="align-middle"><div class="d-flex justify-content-center">${tensi}</div></td>
                        <td class="align-middle"><div class="d-flex justify-content-center">${val(item.height)}</div></td>
                        <td class="align-middle"><div class="d-flex justify-content-center">${val(item.weight)}</div></td>
                    </tr>
                `;
                tbody.append(row);
            });
        }

        // --- EVENT HANDLERS (LIST & DETAIL) ---

        // Klik Baris Pasien
        $('.patient-row').on('click', function(e) {
            // Cegah klik tombol di dalam row memicu detail view
            if ($(e.target).is('input, a') || $(e.target).closest('a').length > 0) return;
            
            const pid = $(this).data('patient-id');
            listView.hide();
            detailView.show();
            // Reset filter detail saat dibuka
            $('#startDateFilter').val('');
            $('#endDateFilter').val('');
            loadPatientData(pid);
        });

        // Tombol Filter Preset (DETAIL)
        $('.btn-filter[data-range]').on('click', function() {
            const range = $(this).data('range');
            const end = new Date();
            let start = new Date();
            end.setHours(23, 59, 59, 999); 

            if (range === 'today') {
                start.setHours(0, 0, 0, 0);
            } else if (range === 'week') {
                start.setDate(end.getDate() - 7);
            } else if (range === 'month') {
                start.setMonth(end.getMonth() - 1);
            }

            const offset = start.getTimezoneOffset() * 60000;
            const localStart = new Date(start.getTime() - offset);
            const localEnd = new Date(end.getTime() - offset);

            const sStr = localStart.toISOString().slice(0, 10);
            const eStr = localEnd.toISOString().slice(0, 10);
            
            $('#startDateFilter').val(sStr);
            $('#endDateFilter').val(eStr);

            loadPatientData(currentPatientId, sStr + " 00:00:00", eStr + " 23:59:59");
        });

        // Tombol Terapkan Filter Manual (DETAIL)
        $('#btnApplyFilter').on('click', function() {
            let s = $('#startDateFilter').val();
            let e = $('#endDateFilter').val();
            if(s && e) {
                loadPatientData(currentPatientId, s + " 00:00:00", e + " 23:59:59");
            } else {
                alert("Pilih tanggal mulai dan selesai.");
            }
        });

        // Tombol Reset Filter (DETAIL)
        $('#btnResetFilter').on('click', function() {
            $('#startDateFilter').val('');
            $('#endDateFilter').val('');
            loadPatientData(currentPatientId);
        });

        // Tombol Kembali
        $('#backToListBtn').on('click', function() { detailView.hide(); listView.show(); });

        // Upload Data Pasien Ini (DETAIL)
        $('#btnUploadCurrentPatient').on('click', function() {
            const btn = $(this);
            const originalText = btn.html();
            
            let s = $('#startDateFilter').val();
            let e = $('#endDateFilter').val();
            let payload = {};
            
            if (s && e) {
                payload = { start_date: s + " 00:00:00", end_date: e + " 23:59:59" };
            }

            if(confirm("Upload data yang sedang ditampilkan ke server?")) {
                btn.prop('disabled', true).text('Mengirim...');
                
                $.ajax({
                    url: `/upload_patient_data/${currentPatientId}`,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(payload),
                    success: function(res) { alert(res.message); },
                    error: function(err) { alert("Gagal upload: " + (err.responseJSON ? err.responseJSON.message : err.statusText)); },
                    complete: function() { btn.prop('disabled', false).html(originalText); }
                });
            }
        });

        // --- EDIT & DELETE (Modal Logic) ---
        const editModal = $("#editPatientModal");

        $(".action-btn-edit").on("click", function (e) {
            e.preventDefault(); e.stopPropagation();
            const row = $(this).closest(".patient-row");
            const patientId = row.data("patient-id");

            $.getJSON(`/api/patient/${patientId}`, function (data) {
                $("#edit_patient_id").val(data.id);
                $("#edit_nama_lengkap").val(data.nama_lengkap);
                $("#edit_jenis_kelamin").val(data.jenis_kelamin);
                $("#edit_alamat").val(data.alamat);
                $("#edit_umur").val(data.umur);
                $("#edit_nik").val(data.nik);
                $("#edit_no_hp").val(data.no_hp);
                $("#editPatientForm").data("patient-id", data.id);
                editModal.css("display", "flex");
            });
        });

        $("#editPatientForm").on("submit", function (e) {
            e.preventDefault();
            const patientId = $(this).data("patient-id");
            const formData = $(this).serialize();

            $.ajax({
                url: `/patient/edit/${patientId}`,
                method: "POST",
                data: formData,
                success: function (response) {
                    if (response.status === "success") {
                        editModal.hide();
                        showNotification(response.message, "success");
                        const updatedName = $("#edit_nama_lengkap").val();
                        $(`.patient-row[data-patient-id=${patientId}] .patient-name`).text(updatedName);
                    }
                },
                error: function () { showNotification("Gagal memperbarui data.", "danger"); }
            });
        });

        $("#cancelEditBtn").on("click", function () { editModal.hide(); });

        $(".action-btn-delete").on("click", function (e) {
            e.preventDefault(); e.stopPropagation();
            const row = $(this).closest(".patient-row");
            const patientId = row.data("patient-id");
            const patientName = row.data("patient-name");
            $("#deletePatientName").text(patientName);
            $("#deleteConfirmModal").css("display", "flex");
            $("#btnConfirmDelete").data("patient-id", patientId).data("row-element", row);
        });

        $("#btnConfirmDelete").on("click", function () {
            const patientId = $(this).data("patient-id");
            const row = $(this).data("row-element");
            $.ajax({
                url: `/patient/delete/${patientId}`,
                method: "POST",
                success: function (response) {
                    if (response.status === "success") {
                        showNotification(response.message, "success");
                        row.fadeOut(500, function () { $(this).remove(); });
                    }
                },
                complete: function () { $("#deleteConfirmModal").hide(); }
            });
        });

        $("#btnCancelDelete").on("click", function () { $("#deleteConfirmModal").hide(); });

        // Helper Notification
        function showNotification(message, category) {
            const flashMessage = $("<div></div>").addClass(`flash-message flash-${category}`).text(message);
            $(".flash-messages-container").append(flashMessage);
            setTimeout(() => {
                flashMessage.fadeOut(500, function () { $(this).remove(); });
            }, 5000);
        }

        // Export Selected Logic
        const exportSelectedBtn = $("#exportSelectedBtn");
        $(".patient-checkbox").on("change", function () {
            const selectedCheckboxes = $(".patient-checkbox:checked");
            if (selectedCheckboxes.length > 0) {
                const selectedIds = selectedCheckboxes.map(function () { return $(this).val(); }).get();
                const exportUrl = `{{ url_for('export_selected') }}?ids=${selectedIds.join(",")}`;
                exportSelectedBtn.attr("href", exportUrl).removeClass("disabled");
            } else {
                exportSelectedBtn.removeAttr("href").addClass("disabled");
            }
        });
    });
</script>
{% endblock %}