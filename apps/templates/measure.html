{% extends 'base.html' %} 
{% block title %}Pengukuran Pasien{% endblock %} 
{% block content %}

<div id="patientChoiceModal" class="modal-overlay">
    <div class="modal-content">
        <span class="modal-close-btn">&times;</span>
        <h2>Status Pasien</h2>
        <p>Apakah pasien sudah pernah melakukan pengukuran sebelumnya?</p>
        <div class="modal-actions">
            <button id="btnNewPatient" class="btn-modal btn-success">Belum, Pasien Baru</button>
            <button id="btnExistingPatient" class="btn-modal btn-primary">Ya, Pasien Lama</button>
        </div>
    </div>
</div>

<div id="measurementChoiceModal" class="modal-overlay" style="display: none">
    <div class="modal-content">
        <h2>Pilih Jenis Pengukuran</h2>
        <div class="measurement-buttons">
            <button class="btn-measure" data-type="asam_urat" data-flag="2">Asam Urat</button>
            <button class="btn-measure" data-type="cholesterol" data-flag="1">Kolesterol</button>
            <button class="btn-measure" data-type="gula_darah" data-flag="3">Gula Darah</button>
            <button class="btn-measure" data-type="tensi" data-flag="4">Tekanan Darah</button>
            <button class="btn-measure" data-type="tinggi_badan" data-flag="5">Tinggi Badan</button>
            <button class="btn-measure" data-type="berat_badan" data-flag="6">Berat Badan</button>
        </div>
        <button id="btnFinishSession" class="btn-modal btn-danger" style="margin-top: 20px">Selesai Sesi</button>
    </div>
</div>

<div id="instructionModal" class="modal-overlay" style="display: none; z-index: 2000;">
    <div class="modal-content" style="max-width: 400px; text-align: center;">
        <div style="font-size: 3rem; color: #f39c12; margin-bottom: 15px;">
            <i class="fas fa-hand-holding-medical"></i>
        </div>
        <h3>Persiapan Alat</h3>
        <p id="instructionText" style="font-size: 1.1rem; color: #555; margin-bottom: 25px;">
            Silakan masukkan jari anda ke alat.
        </p>
        <button id="btnProceedMeasurement" class="btn-modal btn-primary" style="width: 100%;">
            OK, Mulai Mengukur
        </button>
    </div>
</div>

<div id="measurementContent" style="display: none">
    <h1 class="page-title">Pengukuran Pasien</h1>

    <div id="existingPatientSection" style="display: none">
        <div class="form-container">
            <h3>Cari Pasien Terdaftar</h3>
            <div class="form-group autocomplete">
                <label>Nama Pasien</label>
                <input type="text" id="search_patient_name" placeholder="Ketik nama pasien..." />
                <div id="autocomplete-list" class="autocomplete-items"></div>
            </div>
        </div>
    </div>

    <div id="measurementControl" class="form-container" style="display: none">
        <div id="patientDetails" class="patient-details-container">
            <h3>Detail Pasien</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div>
                    <p><strong>Nama:</strong> <span id="detail_nama"></span></p>
                    <p><strong>NIK:</strong> <span id="detail_nik"></span></p>
                    <p><strong>Umur:</strong> <span id="detail_umur"></span></p>
                </div>
                <div>
                    <p><strong>Gender:</strong> <span id="detail_jenis_kelamin"></span></p>
                    <p><strong>Kecamatan:</strong> <span id="detail_kecamatan"></span>, Kelurahan: <span id="detail_kelurahan"></span></p>
                    <p><strong>Email:</strong> <span id="detail_email"></span></p>
                </div>
            </div>
            <p style="margin-top: 10px;"><strong>Alamat:</strong> <span id="detail_alamat"></span></p>
        </div>
        
        <button id="btnStartSession" class="btn-submit">Mulai Sesi Pengukuran</button>

        <div id="postMeasurementActions" style="display: none; margin-top: 20px; gap: 15px; justify-content: flex-start;">
            <button id="btnPrint" class="btn-action btn-print"><i class="fas fa-print"></i> Print Data</button>
            <button id="btnEmail" class="btn-action btn-email"><i class="fas fa-envelope"></i> Kirim Email</button>
            <button id="btnFinalFinish" class="btn-action btn-finish-final">Akhiri <i class="fas fa-check"></i></button>
        </div>
    </div>

    <div class="results-grid">
        <div class="result-box" data-type="asam_urat">
            <h4>Asam Urat</h4>
            <p class="measure-status"></p>
            <p class="value">-</p>
            <p class="classification-status" style="font-weight: bold; margin-top: 5px;"></p>
        </div>

        <div class="result-box" data-type="cholesterol">
            <h4>Kolesterol</h4>
            <p class="measure-status"></p>
            <p class="value">-</p>
            <p class="classification-status" style="font-weight: bold; margin-top: 5px;"></p>
        </div>

        <div class="result-box" data-type="gula_darah">
            <h4>Gula Darah</h4>
            <p class="measure-status"></p>
            <p class="value">-</p>
            <p class="classification-status" style="font-weight: bold; margin-top: 5px;"></p>
        </div>

        <div class="result-box" data-type="tensi">
            <h4>Tekanan Darah</h4>
            <p class="measure-status">Menunggu Pengukuran</p>
            <p class="value">-</p>
            <p class="numeric-indicator">Pulse: - bpm</p>
            <p class="classification-status" style="font-weight: bold; margin-top: 5px;"></p>    
        </div>

        <div class="result-box" data-type="tinggi_badan">
            <h4>Tinggi Badan</h4>
            <p class="measure-status">Menunggu Pengukuran</p>
            <p class="value">-</p>   
        </div>

        <div class="result-box" data-type="berat_badan">
            <h4>Berat Badan</h4>
            <p class="measure-status">Menunggu Pengukuran</p>
            <p class="value">-</p>
        </div>
    </div>
</div>

<div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="loading-content">
        <div class="spinner"></div>
        <h2 id="loadingTitle">Sedang Mengukur...</h2>
        <p id="loadingText">Mengumpulkan data: 0%</p>
    </div>
</div>
{% endblock %} 

{% block scripts %}
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
    $(document).ready(function () {
        const socket = io();
        let currentSessionData = { patient_id: null, patient_gender: 'laki-laki', results: {} };

        // --- CEK DATA AUTO DARI REDIRECT ---
        let autoPatient = null;
        try {
            autoPatient = {{ preselected_patient | tojson | safe if preselected_patient is defined and preselected_patient else 'null' }};
        } catch (e) { console.error(e); }

        // --- FUNGSI LOGIKA KESEHATAN (KLASIFIKASI) ---
        function getHealthStatus(type, value, gender) {
            let val = parseFloat(value);
            let g = (gender || 'laki-laki').toLowerCase();
            if (g.includes('perempuan') || g.includes('wanita')) g = 'perempuan';
            else g = 'laki-laki';

            if (type === 'asam_urat') {
                // Pria: 3.4 - 7.0 | Wanita: 2.4 - 6.0
                if (g === 'laki-laki') {
                    if (val < 3.4) return "Rendah";
                    if (val > 7.0) return "Tinggi (Hiperurisemia)";
                    return "Normal";
                } else {
                    if (val < 2.4) return "Rendah";
                    if (val > 6.0) return "Tinggi (Hiperurisemia)";
                    return "Normal";
                }
            }
            if (type === 'cholesterol') {
                // Umum: < 200 Normal, >= 200 Tinggi
                if (val < 200) return "Normal";
                if (val >= 200 && val < 240) return "Ambang Batas Tinggi";
                return "Tinggi (Hiperkolesterolemia)";
            }
            if (type === 'gula_darah') {
                // Umum: 70 - 140 Normal (Sewaktu/Acak)
                if (val < 70) return "Rendah (Hipoglikemia)";
                if (val > 140) return "Tinggi (Hiperglikemia)";
                return "Normal";
            }
            return ""; // Default
        }

        // --- FUNGSI UI ---
        function showPatientDataAndControls(patient) {
            currentSessionData.patient_id = patient.id;
            currentSessionData.patient_name = patient.nama;
            currentSessionData.patient_gender = patient.jenis_kelamin; // Simpan gender untuk logika
            
            $("#detail_nama").text(patient.nama);
            $("#detail_nik").text(patient.nik);
            $("#detail_alamat").text(patient.alamat);
            $("#detail_umur").text(patient.umur);
            $("#detail_jenis_kelamin").text(patient.jenis_kelamin);
            if(patient.email) $("#detail_email").text(patient.email);
            if(patient.kecamatan) $("#detail_kecamatan").text(patient.kecamatan);
            $("#detail_kelurahan").text(patient.kelurahan || '-');

            $("#measurementControl").show();
            $('#btnStartSession').show();
            $('#postMeasurementActions').hide();
        }

        function resetMeasurementPage() {
            if (!autoPatient) {
                $('#measurementContent').hide();
                $("#patientChoiceModal").css("display", "flex");
            }
            $('#existingPatientSection').hide();
            $('#measurementControl').hide();
            
            currentSessionData = { patient_id: null, patient_gender: 'laki-laki', results: {} };
            $('#search_patient_name').val("");
            
            // Reset Kotak Hasil
            $(".result-box .value").text("-");
            $(".result-box .numeric-indicator").text("");
            $(".result-box .measure-status").text("");
            $('.result-box .action-buttons').remove();
            $(".classification-status").text("").removeClass('status-normal status-tinggi status-rendah');
        }

        
        function executeMeasurement(type, flag, label) {
            const box = $(`.result-box[data-type=${type}]`);
            
            // 1. Reset Tampilan Kotak
            box.find('.action-buttons').remove();
            box.find('.value').text('-');
            box.find('.classification-status').text('').removeClass('status-normal status-tinggi status-rendah');
            box.find('.numeric-indicator').text('');
        
            // 2. Setup Loading Screen
            $("#loadingTitle").text(`Mengukur ${label}...`);
            if (type === 'tensi') $("#loadingText").text("Mohon tenang, jangan bergerak...");
            else if (type === 'berat_badan') $("#loadingText").text("Silakan naik ke timbangan...");
            else $("#loadingText").text("Sedang membaca data sensor...");

            $("#loadingOverlay").fadeIn();

            // 3. Emit Socket ke Backend
            socket.emit("start_measurement", { 
                type: type, 
                flag: flag, 
                patient_id: currentSessionData.patient_id, 
                patient_name: currentSessionData.patient_name 
            });
        }

        function showActionButtons(type) {
            const resultBox = $(`.result-box[data-type=${type}]`);
            const measureButton = $(`.btn-measure[data-type=${type}]`);

            measureButton.text("Selesai").addClass("btn-selesai"); 
            resultBox.find(".measure-status").text("Selesai");
            resultBox.find(".action-buttons").remove();
            
            const div = $('<div class="action-buttons" style="margin-top: 15px; display: flex; gap: 10px; justify-content: center;"></div>');
            const btnUlang = $('<button class="btn-ulang">Ulang</button>').click(function () {
                div.remove();
                resultBox.find(".value").text("-");
                resultBox.find(".classification-status").text(""); 

                let label = measureButton.data("type").replace(/_/g, " ").toUpperCase();
                measureButton.removeClass("btn-selesai").prop("disabled", false).css("background-color", "white").text(label);
                
                $("#loadingTitle").text(`Mengukur ${label}...`);
                $("#loadingOverlay").fadeIn();

                socket.emit("start_measurement", { 
                    type: type, 
                    flag: measureButton.data("flag"), 
                    patient_id: currentSessionData.patient_id, 
                    patient_name: currentSessionData.patient_name 
                });
            });

            const btnOk = $('<button class="btn-ok">OK</button>').click(function () {
                div.remove();
                $("#measurementChoiceModal").css("display", "flex");
            });

            div.append(btnUlang).append(btnOk);
            resultBox.append(div);
        }

        // --- INIT ---
        if (autoPatient) {
            $("#patientChoiceModal").hide();
            $("#measurementContent").show();
            $("#existingPatientSection").hide();
            showPatientDataAndControls(autoPatient);
        } else {
            resetMeasurementPage();
        }

        // --- HANDLERS ---
        $(".modal-close-btn").click(() => window.location.href = "{{ url_for('dashboard') }}");
        $("#btnNewPatient").click(() => window.location.href = "{{ url_for('input_pasien', source='measure') }}");
        
        $("#btnExistingPatient").click(function () {
            $("#patientChoiceModal").hide();
            $("#measurementContent").show();
            $("#existingPatientSection").show();
            $("#measurementControl").hide();
        });

        $("#search_patient_name").on("input", function () {
            const q = $(this).val();
            const list = $("#autocomplete-list");
            if (q.length < 2) { list.empty(); return; }
            
            $.getJSON(`/api/search_patients?q=${q}`, function (data) {
                list.empty();
                $.each(data, function (i, p) {
                    $("<div>").html(`<strong>${p.nama}</strong><br><small>${p.nik}</small>`)
                        .click(() => {
                            list.empty();
                            $("#existingPatientSection").hide();
                            showPatientDataAndControls(p);
                        }).appendTo(list);
                });
            });
        });

        $("#btnStartSession").click(function () {
            $("#measurementChoiceModal").css("display", "flex");
            $(".btn-measure").prop("disabled", false).css("background-color", "white").each(function() {
                let label = $(this).data("type").replace(/_/g, " ").toUpperCase();
                $(this).text(label).removeClass("btn-selesai");
            });
        });

        $("#btnFinishSession").click(function () {
            $("#measurementChoiceModal").hide();
            if (Object.keys(currentSessionData.results).length > 0) socket.emit("save_session_data", currentSessionData);
            else showNotification("Belum ada data.", "warning");
        });

        $(".btn-measure").on("click", function () {
            const type = $(this).data("type");
            const flag = $(this).data("flag");
            const label = $(this).text().trim(); 

            // 1. Tutup Modal Pilihan Menu
            $("#measurementChoiceModal").hide();

            // 2. CEK TIPE: Apakah butuh instruksi (invansif)?
            if (['gula_darah', 'cholesterol', 'asam_urat'].includes(type)) {
                // Simpan data dulu, tunggu konfirmasi user
                pendingMeasurement = { type: type, flag: flag, label: label };
                
                // Set Teks Instruksi
                $("#instructionText").html(`Untuk pengukuran <strong>${label}</strong>, silakan masukkan jari anda ke alat sekarang.`);
                
                // Tampilkan Modal Instruksi
                $("#instructionModal").css("display", "flex");
            } else {
                // Tipe Non-Invasif (Tensi, BB, TB) langsung jalan
                executeMeasurement(type, flag, label);
            }
        });

        // Handler Tombol OK pada Modal Instruksi
        $("#btnProceedMeasurement").on("click", function() {
            $("#instructionModal").hide();
            if (pendingMeasurement) {
                // Lanjut eksekusi pengukuran yang tertunda
                executeMeasurement(pendingMeasurement.type, pendingMeasurement.flag, pendingMeasurement.label);
                pendingMeasurement = null; // Reset
            }
        });

        // --- NAVIGASI DAN EVENT LAINNYA ---
        
        $(".modal-close-btn").on("click", function () { window.location.href = "{{ url_for('dashboard') }}"; });
        $("#btnNewPatient").on("click", function () { window.location.href = "{{ url_for('input_pasien', source='measure') }}"; });
        $("#btnExistingPatient").on("click", function () {
            $("#patientChoiceModal").hide();
            $("#measurementContent").show();
            $("#existingPatientSection").show();
            $("#measurementControl").hide();
        });

        socket.on("measurement_progress", function (data) {
            if (data.current && data.target > 0) {
                const pct = Math.round((data.current / data.target) * 100);
                $("#loadingText").text(`Mengumpulkan data: ${pct}%`);
                if (pct >= 100) $("#loadingText").text("Memproses prediksi...");
            }
        });

        // --- SOCKETS ---
        socket.on("measurement_update", function (data) {
            $("#loadingOverlay").fadeOut();
            if (data.type === 'tensi') {
                const box = $(`.result-box[data-type="tensi"]`);
                box.find(".value").text(`${data.sys}/${data.dia} mmHg`);
                box.find(".numeric-indicator").text(`Pulse: ${data.pulse} bpm`);
                currentSessionData.results['tensi'] = { sys: data.sys, dia: data.dia };
                
                // Klasifikasi Tensi
                let sys = parseInt(data.sys);
                let dia = parseInt(data.dia);
                let status = "Normal";
                if(sys >= 160 || dia >= 100) status = "Hipertensi Grade 2";
                else if(sys >= 140 || dia >= 90) status = "Hipertensi Grade 1";
                else if(sys >= 120 || dia >= 80) status = "Pre-Hipertensi";
                
                box.find(".classification-status").text(status);
                showActionButtons('tensi');
            } else if(data.type === 'berat_badan') {
                const resultBox = $(`.result-box[data-type="berat_badan"]`);
                resultBox.find(".value").text(`${data.value} kg`);
                currentSessionData.results['berat_badan'] = data.value;
                showActionButtons('berat_badan');
            }
            else if (data.type === 'tinggi_badan') {
                const resultBox = $(`.result-box[data-type="tinggi_badan"]`);
                resultBox.find(".value").text(`${data.value} cm`);
                currentSessionData.results['tinggi_badan'] = data.value;
                showActionButtons('tinggi_badan');
            }
        });
        
        socket.on("prediction_result", function (data) {
            $("#loadingOverlay").fadeOut();
            const box = $(`.result-box[data-type=${data.type}]`);
            
            const val = parseFloat(data.value).toFixed(2);
            box.find(".value").text(`${val} mg/dL`);
            currentSessionData.results[data.type] = parseFloat(val);

            // --- HITUNG DAN TAMPILKAN STATUS ---
            const status = getHealthStatus(data.type, val, currentSessionData.patient_gender);
            box.find(".classification-status").text(status);
            
            showActionButtons(data.type);
        });

        socket.on("save_status", function(data) {
            if (data.status === 'success') {
                $('#btnStartSession').hide();
                $('#postMeasurementActions').css('display', 'flex');
                $('html, body').animate({ scrollTop: 0 }, 'fast');
            }
        });

        // --- PRINT ---
        $('#btnPrint').click(function() {
            const btn = $(this);
            const ori = btn.html();
            btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Printing...');
            
            const now = new Date();
            let hasilArray = [];
            
            // Helper untuk ambil status text dari UI
            function getStatus(type) {
                return $(`.result-box[data-type="${type}"] .classification-status`).text() || "-";
            }

            if(currentSessionData.results['asam_urat']) 
                hasilArray.push({tipe: "Asam Urat", nilai: currentSessionData.results['asam_urat'] + " mg/dL", status: getStatus('asam_urat')});
            
            if(currentSessionData.results['cholesterol']) 
                hasilArray.push({tipe: "Kolesterol", nilai: currentSessionData.results['cholesterol'] + " mg/dL", status: getStatus('cholesterol')});
            
            if(currentSessionData.results['gula_darah']) 
                hasilArray.push({tipe: "Gula Darah", nilai: currentSessionData.results['gula_darah'] + " mg/dL", status: getStatus('gula_darah')});
            
            if(currentSessionData.results['tensi']) {
                let val = currentSessionData.results['tensi'];
                hasilArray.push({tipe: "Tensi", nilai: `${val.sys}/${val.dia} mmHg`, status: getStatus('tensi')});
            }
            
            // Tinggi & Berat Tanpa Status
            if(currentSessionData.results['tinggi_badan']) 
                hasilArray.push({tipe: "Tinggi Badan", nilai: currentSessionData.results['tinggi_badan'] + " cm", status: ""});
            
            if(currentSessionData.results['berat_badan']) 
                hasilArray.push({tipe: "Berat Badan", nilai: currentSessionData.results['berat_badan'] + " kg", status: ""});

            const payload = {
                nama: $("#detail_nama").text(),
                tanggal: now.toLocaleDateString('id-ID') + ' ' + now.toLocaleTimeString('id-ID'),
                hasil: hasilArray
            };

            $.ajax({
                url: "/api/print_receipt",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify(payload),
                success: (res) => alert(res.message),
                error: () => alert("Gagal mencetak"),
                complete: () => btn.prop('disabled', false).html(ori)
            });
        });
        $('#btnEmail').on('click', function() {
        if(confirm("Kirim hasil pengukuran ke email pasien? (Fitur ini memerlukan konfigurasi server email)")) {
            // Di sini nanti Anda bisa memanggil AJAX ke endpoint Flask untuk kirim email
            alert("Fitur kirim email akan segera hadir!");
        }
        });

        $('#btnFinalFinish').click(() => window.location.href = "{{ url_for('measure') }}");
    });
</script>
{% endblock %}