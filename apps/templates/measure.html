{% extends 'base.html' %} {% block title %}Pengukuran Pasien{% endblock %} {% block content %}

<div id="patientChoiceModal" class="modal-overlay">
	<div class="modal-content">
		<span class="modal-close-btn">&times;</span>

		<h2>Status Pasien</h2>
		<p>Apakah pasien sudah pernah melakukan pengukuran sebelumnya?</p>
		<div class="modal-actions">
			<button id="btnNewPatient" class="btn-modal btn-success">Belum, Pasien Baru</button>
			<button id="btnExistingPatient" class="btn-modal btn-primary">Ya, Pasien Lama</button>
		</div>
	</div>
</div>

<div id="measurementChoiceModal" class="modal-overlay" style="display: none">
	<div class="modal-content">
		<h2>Pilih Jenis Pengukuran</h2>
		<div class="measurement-buttons">
			<button class="btn-measure" data-type="asam_urat" data-flag="2">Asam Urat</button>
			<button class="btn-measure" data-type="cholesterol" data-flag="1">Kolesterol</button>
			<button class="btn-measure" data-type="gula_darah" data-flag="3">Gula Darah</button>
		</div>
		<button id="btnFinishSession" class="btn-modal btn-danger" style="margin-top: 20px">Selesai Sesi</button>
	</div>
</div>

<div id="measurementContent" style="display: none">
	<h1 class="page-title">Pengukuran Pasien</h1>

	<div id="existingPatientSection" style="display: none">
		<div class="form-container">
			<h3>Cari Pasien Terdaftar</h3>
			<div class="form-group autocomplete">
				<label for="search_patient_name">Nama Pasien</label>
				<input type="text" id="search_patient_name" placeholder="Ketik nama pasien untuk mencari..." />
				<div id="autocomplete-list" class="autocomplete-items"></div>
			</div>
		</div>
	</div>

	<div id="newPatientSection" style="display: none">
		<form id="newPatientForm" class="form-container">
			<h3>Data Pasien Baru</h3>
			<div class="form-row">
				<div class="form-group">
					<label for="nama_pasien">Nama Pasien</label><input type="text" id="nama_pasien" name="nama_pasien" required />
				</div>
				<div class="form-group">
					<label for="jenis_kelamin">Jenis Kelamin</label
					><select id="jenis_kelamin" name="jenis_kelamin">
						<option value="Laki-laki">Laki-laki</option>
						<option value="Perempuan">Perempuan</option>
					</select>
				</div>
				<div class="form-group">
					<label for="alamat">Alamat</label><input type="text" id="alamat" name="alamat" required />
				</div>
			</div>
			<div class="form-row">
				<div class="form-group">
					<label for="umur">Umur</label><input type="number" id="umur" name="umur" required />
				</div>
				<div class="form-group"><label for="nik">NIK</label><input type="text" id="nik" name="nik" required /></div>
				<div class="form-group">
					<label for="no_hp">No. HP</label><input type="text" id="no_hp" name="no_hp" required />
				</div>
			</div>
			<button type="submit" class="btn-submit">Daftarkan Pasien</button>
		</form>
	</div>

	<div id="measurementControl" class="form-container" style="display: none">
        <div id="patientDetails" class="patient-details-container">
            <h3>Detail Pasien</h3>
            <p><strong>Nama:</strong> <span id="detail_nama"></span></p>
            <p><strong>NIK:</strong> <span id="detail_nik"></span></p>
            <p><strong>Umur:</strong> <span id="detail_umur"></span> Tahun</p>
            <p><strong>Jenis Kelamin:</strong> <span id="detail_jenis_kelamin"></span></p>
            <p><strong>Alamat:</strong> <span id="detail_alamat"></span></p>
        </div>
        
        <button id="btnStartSession" class="btn-submit">Mulai Sesi Pengukuran</button>

        <div id="postMeasurementActions" style="display: none; margin-top: 20px; gap: 15px; justify-content: flex-start;">
            <button id="btnPrint" class="btn-action btn-print">
                <i class="fas fa-print"></i> Print Data
            </button>
            <button id="btnEmail" class="btn-action btn-email">
                <i class="fas fa-envelope"></i> Kirim Email
            </button>
            <button id="btnFinalFinish" class="btn-action btn-finish-final">
                Akhiri <i class="fas fa-check"></i>
            </button>
        </div>
    </div>

	<div class="results-grid">
		<div class="result-box" data-type="asam_urat">
			<h4>Asam Urat</h4>
			<p class="reference-range">Normal: 3.4 - 7.0 mg/dL</p>
			<p class="measure-status"></p>
			<p class="value">-</p>
		</div>
		<div class="result-box" data-type="cholesterol">
			<h4>Kolesterol</h4>
			<p class="reference-range">Normal: &lt; 200 | Tinggi: &gt; 240</p>
			<p class="measure-status"></p>
			<p class="value">-</p>
		</div>
		<div class="result-box" data-type="gula_darah">
			<h4>Gula Darah</h4>
			<p class="reference-range">Normal: 70 - 140 mg/dL</p>
			<p class="measure-status"></p>
			<p class="value">-</p>
		</div>
	</div>
</div>
<div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="loading-content">
        <div class="spinner"></div>
        <h2 id="loadingTitle">Sedang Mengukur...</h2>
        <p id="loadingText">Mengumpulkan data: 0%</p>
    </div>
</div>
{% endblock %} {% block scripts %}
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
	$(document).ready(function () {

		const REFERENCE_RANGES = {
        'laki-laki': {
            'asam_urat': 'Normal: 3.4 - 7.0 mg/dL',
            'cholesterol': 'Normal: < 200 mg/dL',
            'gula_darah': 'Normal: 70 - 140 mg/dL'
        },
        'perempuan': {
            'asam_urat': 'Normal: 2.4 - 6.0 mg/dL', // Beda untuk wanita
            'cholesterol': 'Normal: < 200 mg/dL',
            'gula_darah': 'Normal: 70 - 140 mg/dL'
        }
    };

	function updateReferenceRanges(gender) {
			console.log("Gender mentah dari database:", gender); // Debugging

			// Normalisasi: Pastikan string, hapus spasi, ubah ke huruf kecil
			let safeGender = 'laki-laki'; // Default
			
			if (gender && typeof gender === 'string') {
				const cleanGender = gender.trim().toLowerCase();
				if (cleanGender === 'perempuan' || cleanGender === 'wanita') {
					safeGender = 'perempuan';
				}
			}

			const ranges = REFERENCE_RANGES[safeGender];

			// Update teks di setiap kartu
			$(`.result-box[data-type="asam_urat"] .reference-range`).text(ranges.asam_urat);
			$(`.result-box[data-type="cholesterol"] .reference-range`).text(ranges.cholesterol);
			$(`.result-box[data-type="gula_darah"] .reference-range`).text(ranges.gula_darah);
			
			console.log(`Referensi diupdate untuk gender: ${safeGender}`);
		}
		// --- FUNGSI NOTIFIKASI ---
		function showNotification(message, category) {
			const flashMessage = $("<div></div>").addClass(`flash-message flash-${category}`).text(message);
			$(".flash-messages-container").append(flashMessage);
			setTimeout(() => {
				flashMessage.fadeOut(500, function () {
					$(this).remove();
				});
			}, 5000);
		}

			function resetMeasurementPage() {
			$('#measurementContent').hide();
			$('#newPatientSection').hide();
			$('#existingPatientSection').hide();
			$('#measurementControl').hide();
			
			// Kembalikan kondisi tombol
			$('#btnStartSession').show(); // Tampilkan tombol mulai
			$('#postMeasurementActions').css('display', 'none'); // Sembunyikan tombol aksi
			
			currentSessionData = { patient_id: null, results: {} };
			$('#newPatientForm')[0].reset();
			$('#search_patient_name').val("");
			
			$(".result-box .value").text("-");
			$(".result-box .numeric-indicator").text("-- mg/dL");
			$(".result-box .measure-status").text("");
			$('.result-box .action-buttons').remove();
			$(".classification-status").text("-").removeClass('status-normal status-tinggi status-rendah');
			
			$("#patientChoiceModal").css("display", "flex");
		}
		function showActionButtons(type) {
			const resultBox = $(`.result-box[data-type=${type}]`);
			const measureButton = $(`.btn-measure[data-type=${type}]`);

			// 1. UBAH TOMBOL JADI ABU-ABU DENGAN CLASS
			measureButton.text("Selesai");
			measureButton.addClass("btn-selesai"); // <--- INI KUNCINYA


			resultBox.find(".measure-status").text("Pengukuran Selesai");

			

			resultBox.find(".action-buttons").remove();
			const buttonContainer = $(
				'<div class="action-buttons" style="margin-top: 15px; display: flex; gap: 10px; justify-content: center;"></div>'
			);

			const repeatButton = $('<button class="btn-ulang">Ulang</button>').on("click", function () {
				buttonContainer.remove();
			
				resultBox.find(".value").text("-");
				//resultBox.find(".numeric-indicator").text("-- mg/dL");

				let originalText = measureButton
					.data("type")
					.replace(/_/g, " ")
					.replace(/\b\w/g, (l) => l.toUpperCase());
				measureButton.removeClass("btn-selesai");
				measureButton.prop("disabled", false).css("background-color", "white").text(originalText);
				$("#loadingTitle").text(`Mengukur ${originalText}...`);
            	$("#loadingText").text("Menunggu data awal...");
            	$("#loadingOverlay").fadeIn();

				socket.emit("start_measurement", { type: type, flag: measureButton.data("flag"), patient_id: currentSessionData.patient_id, patient_name: currentSessionData.patient_name });
			});

			const okButton = $('<button class="btn-ok">OK</button>').on("click", function () {
				buttonContainer.remove();
				$("#measurementChoiceModal").css("display", "flex");
			});

			buttonContainer.append(repeatButton).append(okButton);
			resultBox.append(buttonContainer);
		}

		// --- KONEKSI WEBSOCKET & STATE MANAGEMENT ---
		const socket = io();
		let currentSessionData = { patient_id: null, results: {} };
		socket.on("connect", () => console.log(""));
		resetMeasurementPage();
		// --- FUNGSI BANTUAN ---
		
		function showPatientDataAndControls(patient) {
			currentSessionData.patient_id = patient.id;
			currentSessionData.patient_name = patient.nama;
			$("#detail_nama").text(patient.nama);
			$("#detail_nik").text(patient.nik);
			$("#detail_alamat").text(patient.alamat);
			$("#detail_umur").text(patient.umur);
			$("#detail_jenis_kelamin").text(patient.jenis_kelamin);
		
			updateReferenceRanges(patient.jenis_kelamin);
			$("#measurementControl").show();
		}

		// --- ALUR 1: MEMULAI HALAMAN ---
		resetMeasurementPage(); // Mulai dengan kondisi bersih

		// --- ALUR 2: PILIHAN PASIEN ---
		$("#btnNewPatient").on("click", function () {
			$("#patientChoiceModal").hide();
			$("#measurementContent").show();
			$("#newPatientSection").show();
		});

		$(".modal-close-btn").on("click", function () {
			// Arahkan pengguna kembali ke halaman dashboard
			window.location.href = "{{ url_for('dashboard') }}";
		});

		$("#btnExistingPatient").on("click", function () {
			$("#patientChoiceModal").hide();
			$("#measurementContent").show();
			$("#existingPatientSection").show();
		});

		// --- ALUR 3: DAFTAR & CARI PASIEN ---
		$("#newPatientForm").on("submit", function (event) {
			event.preventDefault();
			$.ajax({
				url: "{{ url_for('measure') }}",
				method: "POST",
				data: $(this).serialize(),
				success: function (response) {
					if (response.status === "success") {
						showNotification(response.message, "success");
						$("#newPatientSection").hide();
						showPatientDataAndControls(response.patient);
					}
				},
				error: function (response) {
					showNotification(response.responseJSON.message, "danger");
				},
			});
		});

		$("#search_patient_name").on("input", function () {
			const query = $(this).val();
			const autocompleteList = $("#autocomplete-list");
			if (query.length < 2) {
				autocompleteList.empty();
				return;
			}
			$.getJSON(`/api/search_patients?q=${query}`, function (data) {
				autocompleteList.empty();
				$.each(data, function (index, patient) {
					const item = $("<div></div>")
						.html(`<strong>${patient.nama}</strong><br><small>NIK: ${patient.nik}</small>`)
						.on("click", function () {
							$("#existingPatientSection").hide();
							showPatientDataAndControls(patient);
							autocompleteList.empty();
						});
					autocompleteList.append(item);
				});
			});
		});

		// --- ALUR 4: MEMULAI & MENYELESAIKAN SESI PENGUKURAN ---
		$("#btnStartSession").on("click", function () {
			$("#measurementChoiceModal").css("display", "flex");
			$(".result-box .btn-ok").remove();
			$(".btn-measure")
				.prop("disabled", false)
				.text(function () {
					let type = $(this).data("type");
					if (type === "asam_urat") return "Asam Urat";
					if (type === "gula_darah") return "Gula Darah";
					return "Kolesterol";
				})
				.css("background-color", "white");
		});


		$("#btnFinishSession").on("click", function () {
			$("#measurementChoiceModal").hide();
			
			if (Object.keys(currentSessionData.results).length > 0 && currentSessionData.patient_id) {
				// Kirim data untuk disimpan
				socket.emit("save_session_data", currentSessionData);
			} else {
				// Jika tidak ada data, langsung reset (atau bisa tampilkan alert)
				showNotification("Tidak ada data baru. Sesi dibatalkan.", "info");
				resetMeasurementPage();
			}
		});

		$(".btn-measure").on("click", function () {
        const type = $(this).data("type");
        const flag = $(this).data("flag");
        const label = $(this).text(); // Ambil teks tombol (misal: "Kolesterol")

        const box = $(`.result-box[data-type=${type}]`);
        box.find('.action-buttons').remove();
        box.find('.value, .classification-status').text('-');
        box.find('.numeric-indicator').text('-- mg/dL');
        box.find('.classification-status').removeClass('status-normal status-tinggi status-rendah');

        // TAMPILKAN LOADING OVERLAY
        $("#loadingTitle").text(`Mengukur ${label}...`);
        $("#loadingText").text("Menunggu data awal...");
        $("#loadingOverlay").fadeIn();

        $(this).prop("disabled", true).text('Mengukur...');
        socket.emit("start_measurement", { type: type, flag: flag, patient_id: currentSessionData.patient_id, patient_name: currentSessionData.patient_name });
        $("#measurementChoiceModal").hide();
    });

    socket.on("measurement_update", function (data) {
        // Update angka kecil di kartu (opsional, bisa dihapus jika ingin fokus ke overlay saja)
        $(`.result-box[data-type=${data.type}] .numeric-indicator`).text(`${data.value} mg/dL`);
    });
    
    socket.on("measurement_progress", function (data) {
        // UPDATE TEKS DI LOADING OVERLAY
        if (data.current && data.target > 0) {
            const pct = Math.round((data.current / data.target) * 100);
            $("#loadingText").text(`Mengumpulkan data: ${pct}%`);
            
            if (pct >= 100) {
                 $("#loadingText").text("Memproses prediksi...");
            }
        }
    });
		// Handler ini HANYA untuk menampilkan hasil prediksi
		// --- HANDLER UNTUK MENERIMA HASIL PREDIKSI ---
        socket.on("prediction_result", function (data) {
            // 1. HILANGKAN LOADING OVERLAY (Ini perbaikannya)
            $("#loadingOverlay").fadeOut();

            const resultBox = $(`.result-box[data-type=${data.type}]`);

            // 2. Reset status teks di card (opsional, agar bersih)
            resultBox.find(".measure-status").text('');

            // 3. Tampilkan hasil prediksi numerik
            const finalValue = parseFloat(data.value).toFixed(2);
            resultBox.find(".value").text(`${finalValue} mg/dL`);
            
            // Update juga indikator kecil di bawah (jika masih digunakan)
            //resultBox.find(".numeric-indicator").text(`${finalValue} mg/dL`);

            // 4. Simpan hasil numerik untuk dikirim ke DB
            currentSessionData.results[data.type] = parseFloat(finalValue);
            
            // 5. Tampilkan tombol OK/Ulang
            showActionButtons(data.type);
        });

		socket.on("save_status", function (data) {
        showNotification(data.message, data.status);
        
        if (data.status === 'success') {
            // JANGAN RESET HALAMAN DISINI.
            // Tapi ubah UI ke mode "Pasca Pengukuran"
            
            // 1. Sembunyikan tombol Mulai Sesi
            $('#btnStartSession').hide();
            
            // 2. Tampilkan tombol Print/Email/Selesai dengan Flexbox
            $('#postMeasurementActions').css('display', 'flex');
            
            // Opsional: Scroll ke atas agar terlihat
            $('html, body').animate({ scrollTop: 0 }, 'fast');
        } else {
            // Jika gagal simpan, biarkan user mencoba lagi atau reset manual
        }
    });

    // --- HANDLER UNTUK TOMBOL-TOMBOL BARU ---
    
    // 1. Tombol Print
    $('#btnPrint').on('click', function() {
        const btn = $(this);
        
        // Kumpulkan data saat ini untuk dicetak
        // Kita ambil data dari currentSessionData dan tampilan layar
        
        // Format Tanggal Hari ini
        const now = new Date();
        const dateStr = now.toLocaleDateString('id-ID') + ' ' + now.toLocaleTimeString('id-ID');

        let hasilArray = [];
        
        // Cek Asam Urat
        if(currentSessionData.results['asam_urat']) {
             let val = currentSessionData.results['asam_urat'];
             let status = $(`.result-box[data-type="asam_urat"] .classification-status`).text();
             hasilArray.push({tipe: "Asam Urat", nilai: val + " mg/dL", status: status});
        }
        // Cek Kolesterol
        if(currentSessionData.results['cholesterol']) {
             let val = currentSessionData.results['cholesterol'];
             let status = $(`.result-box[data-type="cholesterol"] .classification-status`).text();
             hasilArray.push({tipe: "Kolesterol", nilai: val + " mg/dL", status: status});
        }
        // Cek Gula Darah
        if(currentSessionData.results['gula_darah']) {
             let val = currentSessionData.results['gula_darah'];
             let status = $(`.result-box[data-type="gula_darah"] .classification-status`).text();
             hasilArray.push({tipe: "Gula Darah", nilai: val + " mg/dL", status: status});
        }

        const payload = {
            nama: $("#detail_nama").text(),
            tanggal: dateStr,
            hasil: hasilArray
        };

        // Efek Loading Tombol
        let originalText = btn.html();
        btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Mencetak...');

        // Kirim ke Backend
        $.ajax({
            url: "/api/print_receipt",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify(payload),
            success: function(response) {
                showNotification(response.message, "success");
            },
            error: function(err) {
                let msg = err.responseJSON ? err.responseJSON.message : "Gagal mencetak";
                showNotification(msg, "danger");
            },
            complete: function() {
                btn.prop('disabled', false).html(originalText);
            }
        });
    });

    // 2. Tombol Email (Placeholder)
    $('#btnEmail').on('click', function() {
        if(confirm("Kirim hasil pengukuran ke email pasien? (Fitur ini memerlukan konfigurasi server email)")) {
            // Di sini nanti Anda bisa memanggil AJAX ke endpoint Flask untuk kirim email
            alert("Fitur kirim email akan segera hadir!");
        }
    });

    // 3. Tombol Selesai (Final)
    $('#btnFinalFinish').on('click', function() {
        // Ini yang akan me-reset halaman kembali ke pemilihan pasien
        resetMeasurementPage();
    });
	});
</script>
{% endblock %}
